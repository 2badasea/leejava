<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.bada.leejava.quizcard.QuizcardMapper">

	<insert id="quizcardSetCreate" parameterType="co.bada.leejava.quizcard.QuizcardVO">
		INSERT INTO QUIZCARD VALUES(
			SET_NO_SEQ.NEXTVAL,   <!-- 시퀀스 적용. -->
			#{m_email},
			#{quizcard_set_name},
			TO_CHAR( SYSDATE),
			TO_CHAR( SYSDATE),
			0,
			#{quizcard_set_status},
			#{quizcard_set_intro},
			0,
			#{quizcard_type}
		)
	</insert>
	
	<select id="quizcardSetNoGet" resultType="int">
		SELECT LAST_NUMBER
			FROM USER_SEQUENCES
		WHERE SEQUENCE_NAME = 'SET_NO_SEQ'
	</select>
	
	<insert id="quizcardCategory" parameterType="co.bada.leejava.quizcard.QuizcardVO">
		insert into quizcard_category values(
			1,
			#{quizcard_set_no},
			#{quizcard_category}
		)
	</insert>
	
	<select id="quizcardSelect" resultType="co.bada.leejava.quizcard.QuizcardVO">
		SELECT Q.QUIZCARD_SET_NO, Q.QUIZCARD_SET_NAME, Q.QUIZCARD_SET_CDATE, 
				Q.QUIZCARD_SET_UDATE, Q.QUIZCARD_SET_STATUS, Q.QUIZCARD_SET_INTRO,
				 Q.QUIZCARD_TYPE ,C.QUIZCARD_CATEGORY 
		FROM QUIZCARD Q INNER JOIN QUIZCARD_CATEGORY C 
		ON Q.QUIZCARD_SET_NO = C.QUIZCARD_SET_NO
		WHERE Q.QUIZCARD_SET_NO = #{quizcard_set_no}
	</select>
	
	<!--퀴즈카드 첫 생성 이후 기본 question테이블 값. -->
	<insert id="firstQuestionInsert" parameterType="co.bada.leejava.quizcard.QuizcardVO">
		INSERT INTO QUIZCARD_QUESTION VALUES(
			TO_NUMBER( #{quizcard_set_no}||'0'||1 ),
			1,
			#{quizcard_set_no},
			'문제를 입력하세요',
			'힌트를 입력하세요',
			'답안을 입력하세요'
		)
	</insert>
	
	<!-- 퀴즈카드 메인페이지 게시판에 보여줄 목록 -->
	<select id="quizcardList" resultType="co.bada.leejava.quizcard.QuizcardVO">
		SELECT  S.QUIZCARD_SET_NO,  S.QUIZCARD_SET_HIT, S.QUIZCARD_SET_LIKEIT, 
				S.QUIZCARD_SET_CDATE, S.QUIZCARD_SET_UDATE, S.QUIZCARD_TYPE,
				S.QUIZCARD_SET_NAME, M.M_NICKNAME, C.QUIZCARD_CATEGORY
		FROM QUIZCARD S INNER JOIN QUIZCARD_CATEGORY C
							ON  S.QUIZCARD_SET_NO = C.QUIZCARD_SET_NO
						INNER JOIN MEMBER M
							ON M.M_EMAIL = S.M_EMAIL
		WHERE S.QUIZCARD_SET_STATUS = 'PUBLIC'				
		ORDER BY S.QUIZCARD_SET_NO DESC
	</select>
	
	<!-- 아카이브 박스 내가 생성한 세트 이름 조회 -->
	<select id="ajaxMyQuizcard" resultType="co.bada.leejava.quizcard.QuizcardVO">
		SELECT S.QUIZCARD_SET_NO, S.QUIZCARD_SET_NAME,  S.QUIZCARD_SET_CDATE, 
						S.QUIZCARD_SET_UDATE, C.QUIZCARD_CATEGORY
		FROM QUIZCARD S INNER JOIN QUIZCARD_CATEGORY C
			ON S.QUIZCARD_SET_NO = C.QUIZCARD_SET_NO
		WHERE M_EMAIL = #{m_email}
	</select>
	
	<!-- 해당 퀴즈카드 set_no별로 총 문제 갯수 -->
	<select id="quizcardQuestionCount" parameterType="co.bada.leejava.quizcard.QuizcardVO" resultType="int">
		SELECT COUNT(QUIZCARD_NO) 
			FROM QUIZCARD_QUESTION 
		WHERE QUIZCARD_SET_NO = #{quizcard_set_no}
	</select>
	
	<!-- 해당 퀴즈카드 set_no 기준 댃글 갯수 조회 -->
	<select id="quizcardReplyCount" parameterType="co.bada.leejava.quizcard.QuizcardVO" resultType="int">
		SELECT COUNT(QUIZCARD_REPLY_NO) 
			FROM QUIZCARD_REPLY 
		WHERE QUIZCARD_SET_NO = #{quizcard_set_no}
	</select>
	
	<!-- 퀴즈카드 대기실에서 보여줄 모든 정보 -->
	<select id="quizcardBeforeInfo" resultType="co.bada.leejava.quizcard.QuizcardVO">
		<!--  리턴타입은 ㅟ즈카드 vo객체다. -->
		SELECT M.M_EMAIL, M.M_NICKNAME, S.QUIZCARD_SET_NO, S.QUIZCARD_SET_NAME, S.QUIZCARD_SET_CDATE,
		    	S.QUIZCARD_SET_UDATE, S.QUIZCARD_SET_LIKEIT, S.QUIZCARD_SET_STATUS, S.QUIZCARD_SET_INTRO, 
		    	S.QUIZCARD_SET_HIT, S.QUIZCARD_TYPE,  C.QUIZCARD_CATEGORY
		FROM QUIZCARD  S INNER JOIN QUIZCARD_CATEGORY C 
							ON S.QUIZCARD_SET_NO  = C.QUIZCARD_SET_NO
		    			INNER JOIN MEMBER M
							ON S.M_EMAIL = M.M_EMAIL
		WHERE S.QUIZCARD_SET_NO = #{quizcard_set_no}
	</select>
	
	<!-- 퀴즈카드 세트번호별 문제리스트. -->
	<select id="quizcardQuestionList" resultType="co.bada.leejava.quizcard.QuizcardVO">
		SELECT * 
		FROM QUIZCARD_QUESTION 
		WHERE QUIZCARD_SET_NO = #{quizcard_set_no}
	</select>
	
	<!-- 퀴즈카드 blur 이벤트에 의한 업데이트 -->
	<update id="ajaxQuestionUpdate" parameterType="co.bada.leejava.quizcard.QuizcardVO">
		UPDATE QUIZCARD_QUESTION 
		SET 
			QUIZCARD_QUESTION_NAME = NVL( #{quizcard_question_name}, QUIZCARD_QUESTION_NAME),
			QUIZCARD_QUESTION_HINT = NVL( #{quizcard_question_hint }, QUIZCARD_QUESTION_HINT),
			QUIZCARD_QUESTION_ANSWER = NVL( #{quizcard_question_answer}, QUIZCARD_QUESTION_ANSWER)
		WHERE
			QUIZCARD_SET_NO = #{quizcard_set_no}
			and QUIZCARD_QUESTION_NO = ${quizcard_question_no}
	</update>
	
	<insert id="ajaxQuestionNew" parameterType="co.bada.leejava.quizcard.QuizcardVO">
		INSERT INTO QUIZCARD_QUESTION VALUES(
			#{quizcard_no},
			#{quizcard_question_no},
			#{quizcard_set_no},
			#{quizcard_question_name},
			#{quizcard_question_hint},
			#{quizcard_question_answer}
		)
	</insert>
	
</mapper>